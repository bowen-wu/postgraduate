<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>Review Item Trainer</title>
    <style>
        body {
            font-family: system-ui, -apple-system;
            background: #f6f6f6;
            padding: 20px;
        }
        header, footer {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }
        button {
            padding: 6px 12px;
        }
        .card {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
        }
        .prompt {
            font-size: 26px;
            font-weight: bold;
        }
        .type {
            font-size: 12px;
            color: #666;
        }
        .hidden {
            visibility: hidden;
        }
        .answer {
            margin-top: 10px;
        }
        .stat {
            margin-top: 12px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>

<header>
    <button onclick="setMode('input')">浏览</button>
    <button onclick="setMode('recall')">遮挡</button>
    <button onclick="prev()">←</button>
    <button onclick="next()">→</button>
</header>

<div class="card" id="card"></div>

<footer>
    <button onclick="markKnow()">我会</button>
    <button onclick="confirm(true)">真的会</button>
    <button onclick="confirm(false)">不会</button>
</footer>

<script>
  /* ========= 配置 ========= */
  const MD_URL =
    "https://raw.githubusercontent.com/bowen-wu/postgraduate/refs/heads/master/english/word/core/Unit10-1.md";
  const STORAGE_KEY = "review_item_progress";

  /* ========= 状态 ========= */
  let items = [];
  let idx = 0;
  let mode = "input";

  /* ========= localStorage ========= */
  function loadAll() {
    return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
  }
  function saveAll(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }
  function getProgress(id) {
    const all = loadAll();
    if (!all[id]) {
      all[id] = { level: 0, seen: 0, wrong: 0, selfMarked: false };
      saveAll(all);
    }
    return all[id];
  }
  function updateProgress(id, fn) {
    const all = loadAll();
    fn(all[id]);
    saveAll(all);
  }

  /* ========= Markdown 解析 ========= */
  function parseMarkdown(md) {
    return md
      .split(/^##\s+/m)
      .filter(Boolean)
      .map(parseBlock);
  }

  function parseBlock(block) {
    const lines = block.split("\n").map(l => l.trim());
    const word = lines[0];

    let phonetic = "";
    let meanings = [];
    let related = [];
    let phrases = [];
    let sentences = [];
    let section = "meaning";

    for (let i = 1; i < lines.length; i++) {
      const line = lines[i];
      if (!line) continue;

      if (line.startsWith("###")) {
        if (line.includes("Related")) section = "related";
        else if (line.includes("Phrase")) section = "phrases";
        else if (line.includes("Sentence")) section = "sentences";
        continue;
      }

      if (line.startsWith("/") && !phonetic) {
        phonetic = line;
        continue;
      }

      if (section === "meaning") meanings.push(line);

      if (section === "related" && line.startsWith("-")) {
        const [w, type] = line.slice(1).trim().split(/\s+/);
        related.push({ word: w, type });
      }

      if (section === "phrases" && line.startsWith("-")) {
        const t = line.slice(1).trim();
        const i = t.search(/[^\x00-\xff]/);
        phrases.push({
          en: i === -1 ? t : t.slice(0, i).trim(),
          cn: i === -1 ? "" : t.slice(i).trim()
        });
      }

      if (section === "sentences" && line.startsWith("-")) {
        const en = line.slice(1).trim();
        const cn = lines[++i] || "";
        sentences.push({ en, cn });
      }
    }

    return { word, phonetic, meanings, related, phrases, sentences };
  }

  /* ========= 展开为 ReviewItem ========= */
  function expand(word) {
    const arr = [];

    arr.push({
      id: `${word.word}::word`,
      type: "word",
      prompt: word.word,
      answer: word.meanings.join("；")
    });

    word.related.forEach(r => {
      arr.push({
        id: `${word.word}::related::${r.word}`,
        type: "related",
        prompt: r.word,
        answer: r.type || ""
      });
    });

    word.phrases.forEach(p => {
      arr.push({
        id: `${word.word}::phrase::${p.en.replace(/\s+/g, "_")}`,
        type: "phrase",
        prompt: p.en,
        answer: p.cn
      });
    });

    word.sentences.forEach((s, i) => {
      arr.push({
        id: `${word.word}::sentence::${i}`,
        type: "sentence",
        prompt: s.en.replace(word.word, "_____"),
        answer: s.en,
        extra: s.cn
      });
    });

    return arr;
  }

  /* ========= 渲染 ========= */
  function render() {
    const it = items[idx];
    const p = getProgress(it.id);

    updateProgress(it.id, x => x.seen++);

    const hide = mode === "recall" && !p.selfMarked;

    document.getElementById("card").innerHTML = `
    <div class="type">${it.type}</div>
    <div class="prompt">${it.prompt}</div>

    <div class="answer ${hide ? "hidden" : ""}">
      ${it.answer}
      ${it.extra ? `<div>${it.extra}</div>` : ""}
    </div>

    <div class="stat">
      熟练度: ${p.level} |
      出现: ${p.seen} |
      错误: ${p.wrong}
    </div>
  `;
  }

  /* ========= 交互 ========= */
  function setMode(m) {
    mode = m;
    render();
  }
  function next() {
    idx = (idx + 1) % items.length;
    render();
  }
  function prev() {
    idx = (idx - 1 + items.length) % items.length;
    render();
  }
  function markKnow() {
    updateProgress(items[idx].id, p => p.selfMarked = true);
    render();
  }
  function confirm(ok) {
    updateProgress(items[idx].id, p => {
      if (ok) p.level = Math.min(p.level + 1, 3);
      else {
        p.wrong++;
        p.level = Math.max(p.level - 1, 0);
      }
      p.selfMarked = false;
    });
    render();
  }

  /* ========= 初始化 ========= */
  fetch(MD_URL)
    .then(r => r.text())
    .then(md => {
      const words = parseMarkdown(md);
      items = words.flatMap(expand);
      render();
    });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Article Compare</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea { width: 90%; height: 200px; margin-top: 10px; }
        label { font-weight: bold; display: block; }
        .diff { margin-top: 10px; white-space: pre-wrap; font-family: monospace; line-height: 1.5; }
        .added { background: yellow; text-decoration: line-through; }
        .removed { background: #fbb6c2; font-weight: bold; }
        table { border-collapse: collapse; margin-top: 10px; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 5px; text-align: left; vertical-align: top; }
        .legend span { display: inline-block; margin-right: 10px; padding: 2px 5px; }
        .red-text-green-bg { background: #d4fcbc; color: red; font-weight: bold; text-decoration: underline; }
        .section { margin-top: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; }
        .question { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .question-wrap { display: flex; align-items: center; gap: 20px; margin-bottom: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>
<h2>Compare Articles</h2>

<div class="question-wrap">
    <div class="question">
        <label for="seq">No.：</label>
        <input type="text" id="seq">
    </div>
    <div class="question">
        <label for="files">Select Markdown file (contains correct articles)：</label>
        <input type="file" id="files" accept=".md">
    </div>
</div>

<!-- Mode 选择 -->
<div id="modeSelection" class="question">
    <label>Mode：</label>
    <label><input type="radio" name="mode" value="Dictation" disabled> Dictation</label>
    <label><input type="radio" name="mode" value="ChToEn" disabled> Ch to En</label>
    <label><input type="radio" name="mode" value="Writing" disabled> Writing</label>
</div>

<!-- Dictation 音频上传（默认隐藏） -->
<div id="audioSection" class="question hidden">
    <label for="audioFile">Optional Audio File：</label>
    <input type="file" id="audioFile" accept="audio/*">
    <audio id="audioPlayer" controls class="hidden" loop></audio>
</div>

<div id="directions"></div>
<div id="chinese"></div>

<br><br>
<label for="textB" id="textBLabel" class="hidden">Your Article (with errors)：</label>
<textarea id="textB" placeholder="Paste your article (Article B) here..." spellcheck="false" class="hidden"></textarea>

<div class="legend hidden" id="legend">
    <strong>Legend:</strong>
    <span class="added">Yellow background</span> = Extra word,
    <span class="removed">Red background</span> = Missing word,
    <span class="red-text-green-bg">(Red text, green background)</span> = Spelling mistake
</div>

<button onclick="compare()" id="compareBtn" class="hidden">Compare</button>

<div id="result" class="diff"></div>

<script src="https://unpkg.com/diff@5.2.0/dist/diff.min.js"></script>
<script src="https://unpkg.com/typo-js@1.2.2/typo.js"></script>

<script>
  let dictionary;
  let fileContent = '';
  let example = '';

  let currentMode = '';

  // 监听 mode 改变
  document.querySelectorAll('input[name="mode"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
      currentMode = e.target.value;
      extractSections(); // mode 改变时调用

      // 显示文章编辑区和按钮
      document.getElementById('textB').classList.remove('hidden');
      document.getElementById('textBLabel').classList.remove('hidden');
      document.getElementById('legend').classList.remove('hidden');
      document.getElementById('compareBtn').classList.remove('hidden');

      // Dictation 模式才显示音频上传
      if (currentMode === 'Dictation') {
        document.getElementById('audioSection').classList.remove('hidden');
      } else {
        // 重置文件选择器，确保用户选择同一个文件能触发事件
        const audioFileInput = document.getElementById('audioFile');
        audioFileInput.value = '';
        document.getElementById('audioSection').classList.add('hidden');
        document.getElementById('audioPlayer').classList.add('hidden');
        document.getElementById('audioPlayer').src = '';
      }
    });
  });

  // 监听音频文件选择
  document.getElementById('audioFile').addEventListener('change', (e) => {
    const file = e.target.files[0];
    const player = document.getElementById('audioPlayer');
    if (file) {
      const url = URL.createObjectURL(file);
      player.src = url;
      player.classList.remove('hidden');
    } else {
      player.src = '';
      player.classList.add('hidden');
    }
  });

  function updateModeStatus() {
    const seqFilled = !!document.getElementById('seq').value.trim();
    const fileSelected = !!fileContent;
    const radios = document.querySelectorAll('input[name="mode"]');
    radios.forEach(radio => radio.disabled = !(seqFilled && fileSelected));
  }

  // 监听 seq 输入
  document.getElementById('seq').addEventListener('input', updateModeStatus);

  // 监听文件选择
  document.getElementById('files').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
      fileContent = await file.text();
      updateModeStatus(); // 文件选择后检查是否启用 Mode
    }
  });

  async function initDictionary() {
    try {
      const aff = await fetch('en_US.aff').then(r => r.text());
      const dic = await fetch('en_US.dic').then(r => r.text());
      dictionary = new Typo('en_US', aff, dic, {platform: 'any'});
    } catch (e) {
      console.warn('Dictionary not loaded, spelling check disabled');
    }
  }

  // 监听文件选择，保存内容
  document.getElementById('files').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
      fileContent = await file.text();
    }
  });

  function markdownToText(md) {
    return md
      .replace(/<br\s*\/?>/gi, '\n')
      .replace(/<[^>]+>/g, '')
      .replace(/\*\*(.*?)\*\*/g, '$1')
      .replace(/&emsp;/g, ' ')
      .replace(/&nbsp;/g, ' ')
      .replace(/\r\n/g, '\n')
      .trim();
  }

  // 提取 Directions、Example 和 译文
  function extractSections() {
    const seq = document.getElementById('seq').value.trim();
    const audioSectionEl = document.getElementById('audioSection');
    const directionsEl = document.getElementById('directions');
    const chineseEl = document.getElementById('chinese');

    directionsEl.innerHTML = '';
    chineseEl.innerHTML = '';

    if (!seq) {
      alert('请输入编号');
      return;
    }
    if (!fileContent) {
      alert('请先选择 Markdown 文件');
      return;
    }

    const regex = new RegExp(`##\\s*${seq}([\\s\\S]*?)(?=##\\s*\\d+|$)`, 'i');
    const match = fileContent.match(regex);
    if (!match) {
      alert(`未找到编号 ${seq} 对应的文章`);
      return;
    }

    const block = match[1];
    const getSection = (title) => {
      const re = new RegExp(`###\\s*${title}([\\s\\S]*?)(?=###|$)`, 'i');
      const m = block.match(re);
      return m ? m[1].trim() : '';
    };

    const directions = markdownToText(getSection('Directions'));
    example = getSection('Example'); // 保留 HTML
    const translation = getSection('译文'); // 保留 HTML

    if (currentMode === 'Dictation') {
      // Dictation 模式才显示音频上传
      audioSectionEl.classList.remove('hidden');
    } else {
      // 重置文件选择器，确保用户选择同一个文件能触发事件
      audioSectionEl.value = '';
      audioSectionEl.classList.add('hidden');
      document.getElementById('audioPlayer').classList.add('hidden');
      document.getElementById('audioPlayer').src = '';

      // 只有中译英模式才显示译文
      if (currentMode === 'ChToEn') {
        chineseEl.innerHTML = `<div class="section">${translation}</div>`;
      } else {
        directionsEl.innerHTML = `<div class="section"><h3>Directions</h3><pre>${directions}</pre></div>`;
      }
    }
  }

  // Compare：直接用 Example 作为 Article A
  async function compare() {
    const textB = document.getElementById('textB').value;
    const resultEl = document.getElementById('result');
    const tableEl = document.getElementById('errorTable');
    resultEl.innerHTML = '';
    tableEl.innerHTML = '';

    if (!example) {
      alert('请先点击 “Extract Directions & Example & Translation” 提取 Example');
      return;
    }
    if (!textB) {
      alert('请输入需要对比的文章（Article B）');
      return;
    }

    // 使用已经提取的 example
    const textA = markdownToText(example);

    const diff = Diff.diffWords(textA, textB);
    let resultHTML = '';
    let errors = [];

    for (let i = 0; i < diff.length; i++) {
      const part = diff[i];

      if (part.removed && i + 1 < diff.length && diff[i + 1].added) {
        const removedWords = part.value.split(/\s+/).filter(Boolean);
        const addedWords = diff[i + 1].value.split(/\s+/).filter(Boolean);

        if (removedWords.length === 1 && addedWords.length === 1) {
          const correct = removedWords[0];
          const wrong = addedWords[0];
          resultHTML += `<span style="color:green;">${correct}</span> `;
          resultHTML += `<span class="red-text-green-bg">(${wrong})</span> `;
          errors.push({word: wrong, correct: correct, type: '拼写错误'});
          i++;
          continue;
        }
      }

      if (part.added) {
        const words = part.value.split(/\s+/).filter(Boolean);
        words.forEach((w) => {
          resultHTML += `<span class="added">${w}</span> `;
          errors.push({word: w, type: '多写'});
        });
      } else if (part.removed) {
        const words = part.value.split(/\s+/).filter(Boolean);
        words.forEach(w => {
          resultHTML += `<span class="removed">${w}</span> `;
          errors.push({word: w, type: '漏写'});
        });
      } else {
        resultHTML += part.value;
      }
    }

    resultEl.innerHTML = resultHTML;
  }

  initDictionary();
</script>
</body>
</html>
